<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç«‹å®šè·³é åˆ†æç³»çµ±</title>
    <style>
        body {
            font-family: "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        .result-section {
            margin-top: 20px;
            display: none;
        }
        .loading {
            display: none;
            font-weight: bold;
            color: #666;
        }
        video {
            margin-top: 10px;
            width: 100%;
        }
        .history-section {
            margin-top: 30px;
            display: none;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
        .folder-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        .file-list {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .file-item {
            margin-bottom: 5px;
        }
        .red-button {
            color: #fff;
            background: #d9534f;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
        }
        .red-button:hover {
            opacity: 0.8;
        }
        .blue-button {
            color: #fff;
            background: #0275d8;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
        }
        .blue-button:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <h1>ç«‹å®šè·³é åˆ†æç³»çµ±</h1>

    <div class="upload-section">
        <h2>ä¸Šå‚³å½±ç‰‡</h2>

        <!-- æ–°å¢èº«é«˜ã€é«”é‡è¼¸å…¥æ¬„ä½ -->
        <div style="margin-bottom: 10px;">
            <label for="heightInput">èº«é«˜ (cm): </label>
            <input type="number" id="heightInput" placeholder="è‹¥ä¸å¡«é è¨­148">
            <label for="weightInput" style="margin-left:15px;">é«”é‡ (kg): </label>
            <input type="number" id="weightInput" placeholder="è‹¥ä¸å¡«é è¨­38">
        </div>

        <input type="file" id="videoInput" accept="video/*">
        <button onclick="uploadVideo()">é–‹å§‹åˆ†æ</button>
        <!-- ã€Œæ­·å²ç´€éŒ„ã€æŒ‰éˆ• -->
        <button onclick="showHistory()">æ­·å²ç´€éŒ„</button>
        <!-- ã€Œå³æ™‚éŒ„å½±ã€æŒ‰éˆ• -->
        <button onclick="toggleRecordingArea()">å³æ™‚éŒ„å½±</button>
    </div>

    <!-- å³æ™‚éŒ„å½±å€å¡Š -->
    <div id="recordingSection" style="display:none; text-align:center; margin-top:20px;">
        <h2>å³æ™‚éŒ„å½±</h2>
        <video id="liveVideo" autoplay muted playsinline style="width: 100%; max-width: 600px;"></video>
        <div style="margin-top:10px;">
            <button id="startRecordingBtn" onclick="startRecording()">é–‹å§‹éŒ„å½±</button>
            <button id="stopRecordingBtn" onclick="stopRecording()" disabled>åœæ­¢éŒ„å½±</button>
            <button id="toggleCameraBtn" onclick="toggleCamera()">åˆ‡æ›é¡é ­</button> <!-- ğŸ”¹æ–°å¢åˆ‡æ›é¡é ­æŒ‰éˆ• -->
        </div>
    </div>

    <div class="loading" id="loading">
        <p>åˆ†æè™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>

    <div class="result-section" id="resultSection">
        <h2>åˆ†æçµæœ</h2>
        <p>é æ¸¬è·é›¢ï¼š<span id="predictedDistance"></span> å…¬åˆ†</p>

        <div class="download-links" style="margin-top:10px;">
            <button id="downloadVideoBtn">ä¸‹è¼‰å½±ç‰‡</button>
            <button id="downloadCSVBtn">ä¸‹è¼‰CSV</button>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„å€å¡Š -->
    <div class="history-section" id="historySection">
        <h2>æ­·å²ç´€éŒ„</h2>
        <!-- æ–°å¢ã€Œåˆªé™¤å…¨éƒ¨ã€æŒ‰éˆ• -->
        <button id="deleteAllBtn" class="red-button" onclick="deleteAllFolders()" style="margin-bottom:10px;">
            åˆªé™¤å…¨éƒ¨
        </button>
        <div id="foldersContainer" class="folder-list">
            <!-- é€™è£¡æœƒå‹•æ…‹è¼‰å…¥æ­·å²è³‡æ–™å¤¾æ¸…å–® -->
        </div>
    </div>

    <script>
        let currentProcessId = null;

        // =============== ä¸Šå‚³å½±ç‰‡ä¸¦åˆ†æ ===============
        async function uploadVideo() {
            const videoInput = document.getElementById('videoInput');
            const file = videoInput.files[0];
            if (!file) {
                alert('è«‹å…ˆé¸æ“‡å½±ç‰‡æª”æ¡ˆ');
                return;
            }

            // è®€å–èº«é«˜ã€é«”é‡æ¬„ä½
            const heightInput = document.getElementById('heightInput');
            const weightInput = document.getElementById('weightInput');

            // è‹¥æœªå¡«ï¼Œå°±ç”¨é è¨­å€¼
            let heightValue = heightInput.value.trim();
            if (!heightValue) {
                heightValue = "148";  // é è¨­ 148
            }
            let weightValue = weightInput.value.trim();
            if (!weightValue) {
                weightValue = "38";   // é è¨­ 38
            }

            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';

            const formData = new FormData();
            formData.append('video', file);
            formData.append('height', heightValue);
            formData.append('weight', weightValue);

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                loadingDiv.style.display = 'none';

                console.log("Received result:", result);

                if (result.status === "success") {
                    // é¡¯ç¤ºçµæœ
                    document.getElementById('resultSection').style.display = 'block';
                    document.getElementById('predictedDistance').textContent = result.predicted_distance;

                    // å½±ç‰‡èˆ‡ CSV ä½¿ç”¨å¾Œç«¯å›å‚³çš„æª”å
                    const videourl = "/result/" + result.process_id + "/" + result.video_filename;
                    const csvurl = "/result/" + result.process_id + "/" + result.csv_filename;

                    // è¨­ç½®ä¸‹è¼‰é€£çµ
                    document.getElementById('downloadVideoBtn').onclick = function() {
                        window.open(videourl, '_blank');
                    };
                    document.getElementById('downloadCSVBtn').onclick = function() {
                        window.open(csvurl, '_blank');
                    };

                    currentProcessId = result.process_id;
                } else {
                    alert('è™•ç†å¤±æ•—ï¼š' + (result.message || 'ä¸æ˜åŸå› '));
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                alert('è™•ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                console.error('Error:', error);
            }
        }

        // =============== å³æ™‚éŒ„å½±åŠŸèƒ½ ===============
        let mediaRecorder;
        let recordedChunks = [];
        let stream = null;

        function toggleRecordingArea() {
            const recSec = document.getElementById('recordingSection');
            // åˆ‡æ›é¡¯ç¤º/éš±è—
            if (recSec.style.display === 'none' || recSec.style.display === '') {
                recSec.style.display = 'block';
                startCamera();
            } else {
                recSec.style.display = 'none';
                stopCamera();
            }
        }
        // stream = null;
        let currentFacingMode = "environment"; // é è¨­å¾Œé¡é ­ (environment)
        async function startCamera() {
        if (stream) {
            stopCamera(); // å…ˆé—œé–‰ç•¶å‰é¡é ­
        }

        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: currentFacingMode // ä½¿ç”¨ç•¶å‰è¨­å®šçš„å‰/å¾Œé¡é ­
                },
                audio: true
            });

            const videoEl = document.getElementById('liveVideo');
            videoEl.srcObject = stream;
        } catch (err) {
            console.error('ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:', err);
            alert('ç„¡æ³•å­˜å–æ”å½±æ©Ÿï¼š' + err.message);
        }
    }
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }
        function toggleCamera() {
        // åˆ‡æ›å‰é¡é ­ â‡„ å¾Œé¡é ­
        currentFacingMode = (currentFacingMode === "user") ? "environment" : "user";
        startCamera(); // é‡æ–°å•Ÿå‹•ç›¸æ©Ÿ
    }

        function startRecording() {
            if (!stream) {
                alert('å°šæœªé–‹å•Ÿæ”å½±æ©Ÿ');
                return;
            }
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = function() {
                // éŒ„å½±åœæ­¢å¾Œï¼Œä¸Šå‚³å½±ç‰‡
                uploadRecordedVideo();
            };

            mediaRecorder.start();
            document.getElementById('startRecordingBtn').disabled = true;
            document.getElementById('stopRecordingBtn').disabled = false;
            console.log('é–‹å§‹éŒ„å½±');
        }

        function stopRecording() {
            if (!mediaRecorder) return;
            mediaRecorder.stop();
            document.getElementById('startRecordingBtn').disabled = false;
            document.getElementById('stopRecordingBtn').disabled = true;
            console.log('åœæ­¢éŒ„å½±');
        }

        async function uploadRecordedVideo() {
            // å°‡ chunks åˆä½µæˆ Blob
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const file = new File([blob], 'recorded_video.webm', { type: 'video/webm' });

            // ä¸€æ¨£è®€å–èº«é«˜ã€é«”é‡
            const heightInput = document.getElementById('heightInput');
            const weightInput = document.getElementById('weightInput');

            let heightValue = heightInput.value.trim();
            if (!heightValue) {
                heightValue = "148";
            }
            let weightValue = weightInput.value.trim();
            if (!weightValue) {
                weightValue = "38";
            }

            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';

            const formData = new FormData();
            formData.append('video', file);
            // åŒæ¨£è¦å‚³éèº«é«˜ã€é«”é‡
            formData.append('height', heightValue);
            formData.append('weight', weightValue);

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                loadingDiv.style.display = 'none';

                console.log("Received result (recorded):", result);

                if (result.status === "success") {
                    document.getElementById('resultSection').style.display = 'block';
                    document.getElementById('predictedDistance').textContent = result.predicted_distance;

                    const videourl = "/result/" + result.process_id + "/" + result.video_filename;
                    const csvurl = "/result/" + result.process_id + "/" + result.csv_filename;

                    document.getElementById('downloadVideoBtn').onclick = function() {
                        window.open(videourl, '_blank');
                    };
                    document.getElementById('downloadCSVBtn').onclick = function() {
                        window.open(csvurl, '_blank');
                    };

                    currentProcessId = result.process_id;
                } else {
                    alert('è™•ç†å¤±æ•—ï¼š' + (result.message || 'ä¸æ˜åŸå› '));
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                alert('è™•ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                console.error('Error:', error);
            }
        }

        // =============== æ­·å²ç´€éŒ„ç›¸é—œ ===============
        // é¡¯ç¤ºæˆ–éš±è—æ­·å²ç´€éŒ„å€å¡Šï¼Œä¸¦è¼‰å…¥æ‰€æœ‰è³‡æ–™å¤¾æ¸…å–®
        async function showHistory() {
            const historySection = document.getElementById('historySection');
            // åˆ‡æ›é¡¯ç¤º
            if (historySection.style.display === 'none' || historySection.style.display === '') {
                historySection.style.display = 'block';
                await loadHistoryFolders();  // è¼‰å…¥æ­·å²è³‡æ–™å¤¾
            } else {
                historySection.style.display = 'none';
            }
        }

        async function loadHistoryFolders() {
            try {
                const res = await fetch('/api/history', { method: 'GET' });
                const data = await res.json();
                console.log('æ­·å²è³‡æ–™å¤¾ï¼š', data);

                const foldersContainer = document.getElementById('foldersContainer');
                foldersContainer.innerHTML = '';  // æ¸…ç©º

                if (!data.folders || data.folders.length === 0) {
                    foldersContainer.innerHTML = '<p>ç›®å‰æ²’æœ‰ä»»ä½•æ­·å²è³‡æ–™ã€‚</p>';
                    return;
                }

                // ä¾åºåˆ—å‡ºæ¯å€‹ process_id è³‡æ–™å¤¾
                data.folders.forEach(folder => {
                    const folderDiv = document.createElement('div');
                    folderDiv.style.marginBottom = '10px';

                    const folderTitle = document.createElement('h3');
                    folderTitle.textContent = `Process ID: ${folder.process_id}`;
                    folderDiv.appendChild(folderTitle);

                    // [åˆªé™¤æ•´å€‹è³‡æ–™å¤¾] æŒ‰éˆ•
                    const deleteFolderBtn = document.createElement('button');
                    deleteFolderBtn.textContent = 'åˆªé™¤è³‡æ–™å¤¾';
                    deleteFolderBtn.className = 'red-button';
                    deleteFolderBtn.onclick = async () => {
                        if (!confirm(`ç¢ºå®šè¦åˆªé™¤è³‡æ–™å¤¾ ${folder.process_id} å—ï¼Ÿ`)) return;
                        await deleteFolder(folder.process_id);
                        await loadHistoryFolders(); // é‡æ–°è¼‰å…¥
                    };
                    folderDiv.appendChild(deleteFolderBtn);

                    // åˆ—å‡ºè©²è³‡æ–™å¤¾å…§çš„æ‰€æœ‰æª”æ¡ˆ
                    const fileList = document.createElement('div');
                    fileList.className = 'file-list';

                    if (folder.files && folder.files.length > 0) {
                        folder.files.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';

                            // æª”å
                            const fileNameSpan = document.createElement('span');
                            fileNameSpan.textContent = file + ' ';

                            // ä¸‹è¼‰æŒ‰éˆ•
                            const downloadBtn = document.createElement('button');
                            downloadBtn.textContent = 'ä¸‹è¼‰';
                            downloadBtn.className = 'blue-button';
                            downloadBtn.onclick = () => {
                                const downloadUrl = `/result/${folder.process_id}/${file}`;
                                window.open(downloadUrl, '_blank');
                            };

                            // åˆªé™¤æŒ‰éˆ•
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'åˆªé™¤';
                            deleteBtn.className = 'red-button';
                            deleteBtn.style.marginLeft = '5px';
                            deleteBtn.onclick = async () => {
                                if (!confirm(`ç¢ºå®šè¦åˆªé™¤æª”æ¡ˆ ${file} å—ï¼Ÿ`)) return;
                                await deleteFile(folder.process_id, file);
                                await loadHistoryFolders(); // é‡æ–°è¼‰å…¥
                            };

                            fileItem.appendChild(fileNameSpan);
                            fileItem.appendChild(downloadBtn);
                            fileItem.appendChild(deleteBtn);
                            fileList.appendChild(fileItem);
                        });
                    } else {
                        fileList.innerHTML = '<p>ç„¡æª”æ¡ˆ</p>';
                    }

                    folderDiv.appendChild(fileList);
                    foldersContainer.appendChild(folderDiv);
                });

            } catch (err) {
                console.error('è¼‰å…¥æ­·å²è³‡æ–™å¤±æ•—', err);
                alert('è¼‰å…¥æ­·å²è³‡æ–™å¤±æ•—ï¼š' + err.message);
            }
        }

        // ä¸€éµã€Œåˆªé™¤å…¨éƒ¨ã€
        async function deleteAllFolders() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­·å²è³‡æ–™å¤¾åŠå…¶æª”æ¡ˆå—ï¼Ÿ')) return;
            try {
                const res = await fetch('/api/delete_all', { method: 'DELETE' });
                const result = await res.json();
                if (result.status === 'success') {
                    alert('å…¨éƒ¨è³‡æ–™å·²åˆªé™¤');
                    await loadHistoryFolders();
                } else {
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (result.message || 'ä¸æ˜åŸå› '));
                }
            } catch (err) {
                alert('åˆªé™¤å…¨éƒ¨å¤±æ•—ï¼š' + err.message);
            }
        }

        async function deleteFolder(process_id) {
            try {
                const res = await fetch(`/api/delete_folder/${process_id}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.status !== 'success') {
                    alert('åˆªé™¤è³‡æ–™å¤¾å¤±æ•—ï¼š' + (result.message || 'ä¸æ˜åŸå› '));
                }
            } catch (err) {
                alert('åˆªé™¤è³‡æ–™å¤¾å¤±æ•—ï¼š' + err.message);
            }
        }

        async function deleteFile(process_id, filename) {
            try {
                const res = await fetch('/api/delete_file', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ process_id, filename })
                });
                const result = await res.json();
                if (result.status !== 'success') {
                    alert('åˆªé™¤æª”æ¡ˆå¤±æ•—ï¼š' + (result.message || 'ä¸æ˜åŸå› '));
                }
            } catch (err) {
                alert('åˆªé™¤æª”æ¡ˆå¤±æ•—ï¼š' + err.message);
            }
        }
    </script>
</body>
</html>
